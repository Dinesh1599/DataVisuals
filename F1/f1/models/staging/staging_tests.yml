version: 2

models:

  # =====================================================================
  # STG_CIRCUITS
  # =====================================================================
  - name: stg_circuits
    columns:
      - name: circuit_id
        tests:
          - not_null
          - unique
      - name: circuit_ref
        tests:
          - not_null
      - name: name
        tests:
          - not_null


  # =====================================================================
  # STG_CONSTRUCTORS
  # =====================================================================
  - name: stg_constructors
    columns:
      - name: constructor_id
        tests:
          - not_null
          - unique
      - name: constructor_ref
        tests:
          - not_null
      - name: name
        tests:
          - not_null


  # =====================================================================
  # STG_DRIVERS
  # =====================================================================
  - name: stg_drivers
    columns:
      - name: driver_id
        tests:
          - not_null
          - unique
      - name: driver_ref
        tests:
          - not_null
      - name: forename
        tests:
          - not_null
      - name: surname
        tests:
          - not_null


  # =====================================================================
  # STG_STATUS
  # =====================================================================
  - name: stg_status
    columns:
      - name: status_id
        tests:
          - not_null
          - unique
      - name: status_text
        tests:
          - not_null


  # =====================================================================
  # STG_SEASONS
  # =====================================================================
  - name: stg_seasons
    columns:
      - name: season_year
        tests:
          - not_null
          - unique


  # =====================================================================
  # STG_RACES
  # =====================================================================
  - name: stg_races
    columns:
      - name: race_id
        tests:
          - not_null
          - unique

      - name: circuit_id
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_circuits')
                field: circuit_id

    tests:
      - dbt_utils.expression_is_true:
            arguments:
              expression: "race_year >= 1950"
      - dbt_utils.expression_is_true:
            arguments:
              expression: "round >= 1"


  # =====================================================================
  # STG_RESULTS
  # =====================================================================
  - name: stg_results
    columns:
      - name: result_id
        tests:
          - not_null
          - unique

      - name: race_id
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_races')
                field: race_id

      - name: driver_id
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_drivers')
                field: driver_id

      - name: constructor_id
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_constructors')
                field: constructor_id

      - name: status_id
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_status')
                field: status_id

    tests:
      - dbt_utils.expression_is_true:
            arguments:
              expression: "position >= 0"
      - dbt_utils.expression_is_true:
            arguments:
              expression: "grid_position >= 0"
      - dbt_utils.expression_is_true:
            arguments:
              expression: "points >= 0"
      - dbt_utils.expression_is_true:
            arguments:
              expression: "laps >= 0"
      - dbt_utils.expression_is_true:
            arguments:
              expression: "milliseconds >= 0"


  # =====================================================================
  # STG_SPRINT_RESULTS
  # =====================================================================
  - name: stg_sprint_results
    columns:
      - name: result_id
        tests:
          - not_null
          - unique

      - name: race_id
        tests:
          - relationships:
              arguments:
                to: ref('stg_races')
                field: race_id

      - name: driver_id
        tests:
          - relationships:
              arguments:
                to: ref('stg_drivers')
                field: driver_id

      - name: constructor_id
        tests:
          - relationships:
              arguments:
                to: ref('stg_constructors')
                field: constructor_id

      - name: status_id
        tests:
          - relationships:
              arguments:
                to: ref('stg_status')
                field: status_id

    tests:
      - dbt_utils.expression_is_true:
          arguments:
            expression: "position >= 0"
      - dbt_utils.expression_is_true:
          arguments:
            expression: "grid_position >= 0"
      - dbt_utils.expression_is_true:
          arguments:
            expression: "points >= 0"
      - dbt_utils.expression_is_true:
          arguments:
            expression: "laps >= 0"
      - dbt_utils.expression_is_true:
          arguments:
            expression: "milliseconds >= 0"


  # =====================================================================
  # STG_QUALIFYING
  # =====================================================================
  - name: stg_qualifying
    columns:
      - name: qualify_id
        tests:
          - not_null
          - unique

      - name: race_id
        tests:
          - relationships:
              arguments:
                to: ref('stg_races')
                field: race_id

      - name: driver_id
        tests:
          - relationships:
              arguments:
                to: ref('stg_drivers')
                field: driver_id

      - name: constructor_id
        tests:
          - relationships:
              arguments:
                to: ref('stg_constructors')
                field: constructor_id

    tests:
      - dbt_utils.expression_is_true:
          arguments:
            expression: "position >= 0"


  # =====================================================================
  # STG_LAP_TIMES
  # =====================================================================
  - name: stg_lap_times
    columns:
      - name: race_id
        tests:
          - relationships:
              arguments:
                to: ref('stg_races')
                field: race_id

      - name: driver_id
        tests:
          - relationships:
              arguments:
                to: ref('stg_drivers')
                field: driver_id

    tests:
      - dbt_utils.expression_is_true:
          arguments:
            expression: "lap >= 1"
      - dbt_utils.expression_is_true:
          arguments:
            expression: "milliseconds >= 0"
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - race_id
              - driver_id
              - lap

  # =====================================================================
  # STG_PIT_STOPS
  # =====================================================================
  - name: stg_pit_stops
    columns:
      - name: race_id
        tests:
          - relationships:
              arguments:
                to: ref('stg_races')
                field: race_id

      - name: driver_id
        tests:
          - relationships:
              arguments:
                to: ref('stg_drivers')
                field: driver_id

    tests:
      - dbt_utils.expression_is_true:
          arguments:
            expression: "stop_number >= 1"
      - dbt_utils.expression_is_true:
          arguments:
            expression: "milliseconds >= 0"
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - race_id
              - driver_id
              - stop_number

  # =====================================================================
  # STG_DRIVER_STANDINGS
  # =====================================================================
  - name: stg_driver_standings
    columns:
      - name: driver_standings_id
        tests:
          - not_null
          - unique

      - name: race_id
        tests:
          - relationships:
              arguments:
                to: ref('stg_races')
                field: race_id

      - name: driver_id
        tests:
          - relationships:
              arguments:
                to: ref('stg_drivers')
                field: driver_id

    tests:
      - dbt_utils.expression_is_true:
          arguments:
            expression: "points >= 0"
      - dbt_utils.expression_is_true:
          arguments:
            expression: "wins >= 0"

  # =====================================================================
  # STG_CONSTRUCTOR_RESULTS
  # =====================================================================
  - name: stg_constructor_results
    columns:
      - name: constructor_results_id
        tests:
          - not_null
          - unique

      - name: race_id
        tests:
          - relationships:
              arguments:
                to: ref('stg_races')
                field: race_id

      - name: constructor_id
        tests:
          - relationships:
              arguments:
                to: ref('stg_constructors')
                field: constructor_id


  # =====================================================================
  # STG_CONSTRUCTOR_STANDINGS
  # =====================================================================
  - name: stg_constructor_standings
    columns:
      - name: constructor_standings_id
        tests:
          - not_null
          - unique

      - name: race_id
        tests:
          - relationships:
              arguments:
                to: ref('stg_races')
                field: race_id

      - name: constructor_id
        tests:
          - relationships:
              arguments:
                to: ref('stg_constructors')
                field: constructor_id

    tests:
      - dbt_utils.expression_is_true:
          arguments:
            expression: "points >= 0"
      - dbt_utils.expression_is_true:
          arguments:
            expression: "wins >= 0"